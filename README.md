# izuna-elastic-monitor
Page for monitor elasticsearch status



## Allocation Explain

1. Назначение
Блок предназначен для анализа причин, по которым определённый шард (или случайный нераспределённый шард) не может быть размещён в кластере Elasticsearch. Это помогает быстро понять, почему некоторые шарды остаются unassigned или не могут быть перемещены.

2. Интерфейс пользователя
Кнопка "Случайный шард" — отправляет запрос на explain для случайного нераспределённого шарда (если такие есть).
Поля ввода:
Индекс — имя индекса, для которого вы хотите проанализировать шард.
Шард — номер шарда.
primary (чекбокс) — если отмечено, анализируется primary-шард, иначе — реплика.
Кнопка "Анализировать конкретный шард" — отправляет запрос на explain для выбранного шарда.

3. Как работает логика
    - При нажатии на любую из кнопок вызывается функция fetchAllocation.
    - Если указаны параметры (индекс, шард, primary), отправляется POST-запрос на `/_cluster/allocation/explain` с телом:
    ```json
    {
    "index": "имя_индекса",
    "shard": "номер_шарда",
    "primary": "true/false"
    }
    ```
    - Если параметры не указаны — отправляется GET-запрос на тот же endpoint (или POST без тела), чтобы получить explain для случайного нераспределённого шарда.

4. Обработка ответа
    - Если сервер возвращает успешный ответ, он отображается в виде prettified JSON.
    - Если сервер возвращает ошибку 400 с текстом, что нет нераспределённых шардов (или с reason, содержащим "No shard was specified in the request which means the response should explain a randomly-chosen unassigned shard, but there are no unassigned shards in this cluster"), выводится сообщение:
    ```text
    "Нет UNASSIGNED шардов"
    ```
    - Если ошибка другая — выводится текст ошибки.

5. Примеры использования
    - Диагностика проблем с размещением шардов:
    Можно быстро узнать, почему шард не назначается (например, нехватка места, ограничения по allocation, отключённые ноды и т.д.).
    - Анализ конкретного шарда:
    Можно вручную указать индекс, номер шарда и тип (primary/replica) для анализа конкретной ситуации.

6. Технические детали
    - Для POST-запроса используется публичный метод сервиса `getAllocationExplainWithBody`.
    - Ответы сервера обрабатываются с учётом специфики ошибок Elasticsearch.
    - UI реагирует на загрузку, ошибки и успешные ответы.

## RAM

В дашборде `RAM` (оперативная память) для каждой ноды кластера отображается в таблице нод (`NodesTable`).
Вот как считается и отображается `RAM`:

1. Источник данных
    - Данные о RAM берутся из ответа Elasticsearch API:
    `/_nodes/stats/os`
    -   В частности, используются поля:
    `os.mem.total_in_bytes` — всего оперативной памяти на ноде
    `os.mem.free_in_bytes` — свободно
    `os.mem.used_in_bytes` — занято

2. Расчёт и отображение
    - Для каждой ноды вычисляется процент использования RAM:
    ```text
    used_percent = (used_in_bytes / total_in_bytes) * 100
    ```
    - В таблице отображается:
        - `Всего:` общий объём RAM (например, 32 GB)
        - `Свободно:` свободная память (например, 8 GB)
        - `Использовано:` занятая память (например, 24 GB)
        - `Процент:` процент использования (например, 75%)
    - Используется прогресс-бар и цветовая индикация для визуализации процента использования.

3. Визуализация
    - В колонке RAM для каждой ноды показывается:
        - Текстовое значение (например, `24 GB / 32 GB (75%)`)
        - Прогресс-бар (цветной, например, зелёный/жёлтый/красный в зависимости от процента)
    - Если данные не получены — отображается прочерк или сообщение об ошибке.

Итого:
RAM считается на основе статистики ОС каждой ноды, берётся из API Elasticsearch, и отображается как абсолютные значения и процент использования с визуальной индикацией.


## Диск

"Диск" (Disk) для каждой ноды отображается в таблице NodesTable и обычно включает три ключевых метрики:
1. `Всего (Total)` — общий размер диска, доступный для Elasticsearch на данной ноде.
2. `Свободно (Free) `— сколько места на диске физически свободно.
3. `Доступно (Available)` — сколько места может быть использовано Elasticsearch (иногда отличается от "свободно" из-за квот, резервов и т.д.).


### Как это считается:

Эти значения берутся из ответа Elasticsearch API, из эндпоинта  `/_nodes/stats`.
    - В ответе для каждой ноды есть поля:
    - `disk.total` — общий размер диска (например, 500gb)
        - `disk.used` — занято (например, 200gb)
        - `disk.avail` — доступно для записи (например, 300gb)
        - `disk.free` — физически свободно (может совпадать с avail, но не всегда)
    - В UI эти значения конвертируются в байты (или более удобные единицы: `GB`, `TB`) и форматируются для отображения.

Пример расчёта:
    -   Если из API приходит:
            `disk.total = 500gb`
            `disk.used = 200gb`
            `disk.avail = 300gb`
В таблице будет показано:
    - `Всего:` 500 GB
    - `Свободно:` 300 GB (или сколько реально доступно для записи)
    - `Использовано:` 200 GB (или рассчитывается как total - avail)

### Важно:
    - `"Available" (доступно)` — это то, что реально может использовать Elasticsearch, и оно может быть меньше - `"free"` из-за системных ограничений.

**Все значения берутся напрямую из Elasticsearch, никаких дополнительных вычислений на стороне фронта, кроме форматирования и расчёта процентов, не делается.**